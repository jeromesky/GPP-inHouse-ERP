(function(I){var L=0;I.widget("ui.htmlInput",{_init:function(){var O=this;this.toolbar=new J("<div class='ui-widget-header'></div>",function(U){var T=I(this);switch(T.attr("name")){case"link":var S=N(O.selectedElement,["a"]);if(S&&!I.browser.msie){O.setSelected(S)}O.options.editLink(U,O,S,O._setLink);break;case"image":O.options.editImage(U,O,N(O.selectedElement,["img"]),O._setImage);break;default:O._applyCommand(T.attr("name"),T.attr("value"));break}});this.toolbar.addButtons(this.options);if(I.browser.safari){this.toolbar.element.css("height","21px")}this.container=I("<div class='ui-htmlInput ui-widget' style='position:relative;overflow:hidden;'></div>").addClass(this.element.attr("class")).attr("id",this.element.attr("id").concat("_container")).append(this.toolbar.element);this.element.after(this.container);var R=this.toolbar.element.outerHeight();if(!this.options.showToolbar){this.toolbar.element.css("display","none");R=0}var P=this.element.outerHeight()-R-3;L++;this._frameId="htmlInput_".concat(L);this._frame=I("<iframe frameborder='no' border='0' marginWidth='0' marginHeight='0' leftMargin='0' topMargin='0' width='100%' height='".concat(P,"px' allowTransparency='true' scroll='yes'>")).attr("id",this._frameId).attr("src",I.browser.msie?"javascript:false;":"javascript:;");if(!this.options.debug){this.element.css("display","none")}this.container.append(I("<div class='ui-widget-content'/>").append(this._frame));this._setContent(this.element.val());this.container.height(this.element.outerHeight()).width(this.options.widthAuto?"auto":this.element.width());this._frame.height(P).css({width:"100%"});var P=this._frame.height();I(this._document).bind("keydown.htmlInput keypress.htmlInput keyup.htmlInput mouseup.htmlInput focus.htmlInput blur.htmlInput",function(S){O._eventBubble(S)});if(this.element[0].form){I(this.element[0].form).bind("submit.htmlInput",function(){O.clean()})}if(I.browser.msie){this._frame.bind("focus.htmlInput",function(S){O._eventBubble(S)}).bind("blur.htmlInput",function(S){O._eventBubble(S)});this._document.body.onpaste=function(){setTimeout(O.clean,0)};this._document.onbeforedeactivate=function(){O.bookmark()};this._document.onactivate=function(){O.restoreBookmark()}}if(I.browser.mozilla||I.browser.safari){this._frame.parents().bind("DOMNodeInserted.htmlInput",function(S){if(I(S.target).find("#".concat(O._frameId)).length==1){setTimeout(O._resetContent,0);S.stopPropagation()}});if(I.browser.mozilla){try{I(O._document.body).bind("input.htmlInput",function(){O.clean()})}catch(Q){}}}if(window.getSelection){this.bookmark=function(){O._bookmark=O._window.getSelection()};this.restoreBookmark=function(){if(O._bookmark){var S=O._window.getSelection();S.removeAllRanges();S.addRange(O._bookmark);O._bookmark=null}};this.getSelected=function(){var U=O._window.getSelection();if(U.rangeCount>0){var S=U.getRangeAt(0);var T=S.collapsed||S.startContainer.childNodes.length==0?U.focusNode:S.startContainer.childNodes[S.startOffset];return T.tagName==undefined?T.parentNode:T}};this.getSelectedHTML=function(){var U=O._window.getSelection();if(U.rangeCount>0){var S=U.getRangeAt(0);var T=document.createElement("div");T.appendChild(S.cloneContents());return T.innerHTML}};this.setSelected=function(U){var T=O._window.getSelection();T.removeAllRanges();if(U){var S=O._document.createRange();S.selectNodeContents(U);T.addRange(S)}};this.insertHtml=function(S){O._document.execCommand("insertHTML",null,S);O.update()}}else{this.bookmark=function(){try{O._bookmark=O._document.selection.createRange()}catch(S){}};this.getSelected=function(){O._window.focus();var S=O._document.selection.createRange();return S.item?S.item(0):S.parentElement()};this.getSelectedHTML=function(){O._window.focus();var S=O._document.selection.createRange();return S.htmlText?S.htmlText:S.item?S.item(0).outerHTML:""};this.setSelected=function(T){try{O._window.focus();var S=O._document.selection.createRange();S=O._document.body.createTextRange();S.moveToElementText(T);S.select()}catch(U){}};this.insertHtml=function(T){var S=this._document.selection.createRange();if(S.item){S.item(0).outerHTML=T}else{S.pasteHTML(T)}O.update()};this.restoreBookmark=function(){if(O._bookmark){O._bookmark.select();O._bookmark=null}}}this._setLink=function(Y,W,T){if(Y=="http:/".concat("/")||Y==""){Y==null}O._window.focus();var V=N(O.selectedElement,["a"]);if(Y==null){if(V!=null){O._document.execCommand("unLink",false,null)}return }else{if(V==null){var U=O.selectedHTML,X="",S=I.htmlClean.trimEndIndex(U);if(S>-1){X=U.substring(S);U=U.substring(0,S)}O.insertHtml("<a href='".concat(Y,"'>",U,"</a>",X));V=N(O.getSelected(),["a"])}}V=I(V);V.attr("href",Y);W!=null&&W.length>0?V.attr("target",W):V.removeAttr("target");T!=null&&T.length>0?V.attr("type",T):V.removeAttr("type");O.update()};this._setImage=function(T){O._window.focus();var S=N(O.selectedElement,["img"]);if(S==null&&T!=null){O._document.execCommand("insertimage",false,T);O.selectedElement=O.getSelected();S=N(O.selectedElement,["img"])}else{if(S!=null&&T==null){return }}S=I(S);S.attr("src",T);O.update()}},value:function(O){if(arguments.length){this._document.body.innerHTML=O;this.clean()}return this._document.body.innerHTML},clean:function(){var O=this._htmlClean(this.value());if(O!=this.element.val()){this.element.val(O);this._change()}},destroy:function(){I.widget.prototype.destroy.apply(this,arguments);this._document.add(this._document.body).add(this._frame).unbind(".htmlInput")},focus:function(){this._window.focus()},update:function(){if(this.getSelected().tagName=="BODY"||(I.browser.safari&&this.getSelected().tagName=="DIV")){this._document.execCommand("formatblock",false,"<p>")}this.selectedElement=this.getSelected();this.selectedHTML=this.getSelectedHTML();this._showStatus();for(var Q in this.toolbar.tools){var P=this.toolbar.tools[Q];var R=false;var O=true;switch(Q){case H.bulletList.command:case H.numberList.command:var S=D(this.selectedElement,["ul","ol"]);R=(Q==H.bulletList.command&&S=="ul")||(Q==H.numberList.command&&S=="ol");break;case H.bold.command:R=N(this.selectedElement,["strong","b",["span",/weight:\s*bold/i]]);break;case H.italic.command:R=N(this.selectedElement,["em","i",["span",/style:\s*italic/i]]);break;case H.superscript.command:R=N(this.selectedElement,["sup",["span",/-align:\s*super/i]]);break;case H.subscript.command:R=N(this.selectedElement,["sub",["span",/-align:\s*sub/i]]);break;case H.block.command:P.command.val(D(this.selectedElement,["p","h1","h2","h3","h4","h5","h6","pre"]));continue;case H.link.command:R=N(this.selectedElement,["a"]);O=R||(this.selectedHTML&&this.selectedHTML.length>0)||N(this.selectedElement,["img"]);break;case H.image.command:R=N(this.selectedElement,["img"]);break;case H.leftAlign.command:R=I(N(this.selectedElement,this.options.canAlign)).hasClass("left");break;case H.middleAlign.command:R=I(N(this.selectedElement,this.options.canAlign)).hasClass("middle");break;case H.rightAlign.command:R=I(N(this.selectedElement,this.options.canAlign)).hasClass("right");break}P.selected(R);P.enabled(O)}},_showStatus:function(){if(this.options.debug){window.status="selected html: '".concat(this.selectedHTML,"' element: ",(this.selectedElement?this.selectedElement.tagName==undefined?this.selectedElement.toString():this.selectedElement.tagName:""))}},_htmlClean:function(P,O){return I.htmlClean?I.htmlClean(P,{allowedClasses:this.options.allowedClasses,replace:O}):P},_change:function(O){this.element.trigger("change",O,{value:this.element.val()})},_eventBubble:function(O){if(O){if(O.type=="blur"){this.clean()}switch(O.type){case"mouseup":case"keyup":this.update();default:this.element.triggerHandler(O.type,O);break}}},_setContent:function(P){this._window=this._frame.attr("contentWindow")?this._frame.attr("contentWindow"):window.frames[this._frameId].window;this._document=this._window.document;P="<html><head>".concat("<link href='",this.options.styleUrl,"' rel='stylesheet' type='text/css' />",this.options.baseUrl?"<base href='".concat(this.options.baseUrl,"' />"):"","<style type='text/css'>body{overflow:auto;}</style></head><body class='editor'>",this._htmlClean(P,[[["strong","big",/span.*?weight:\s*bold/i],"b"],[["em",/span.*?style:\s*italic/i],"i"],[[/span.*?-align:\s*super/i],"sup"],[[/span.*?-align:\s*sub/i],"sub"]]),"</body></html>");try{this._document.designMode="on";this._document.open();this._document.write(P);this._document.close()}catch(Q){}try{this._document.execCommand("useCSS",false,true);this._document.execCommand("styleWithCSS",false,false)}catch(O){}},_resetContent:function(){this._setContent(this.value())},_applyCommand:function(P,O){this.focus();switch(P){default:this._document.execCommand(P,false,null);break;case H.block.command:this._document.execCommand(P,false,"<"+O+">");break;case H.leftAlign.command:I(N(this.selectedElement,this.options.canAlign)).removeClass(H.middleAlign.command).removeClass(H.rightAlign.command).toggleClass(P);break;case H.middleAlign.command:I(N(this.selectedElement,this.options.canAlign)).removeClass(H.leftAlign.command).removeClass(H.rightAlign.command).toggleClass(P);break;case H.rightAlign.command:I(N(this.selectedElement,this.options.canAlign)).removeClass(H.leftAlign.command).removeClass(H.middleAlign.command).toggleClass(P);break;case H.bulletList.command:case H.numberList.command:this._document.execCommand(P,false,null);break}this.update();this.clean()}});function D(P,O){P=N(P,O);return P==null?"":P.tagName.toLowerCase()}function N(P,O){while(P!=null&&(E(P,O)==-1)){P=P.parentNode}return P}function E(R,P){if(R.tagName){var O=R.tagName.toLowerCase();for(var Q=0;Q<P.length;Q++){if(P[Q]==O||(P[Q].constructor==Array&&P[Q][0]==O&&P[Q][1].test(R.getAttribute("style")))){return Q}}}return -1}function C(O){O=N(O,["a"]);return O==null?"":O.href}var B;function G(T,S,P,V,R,Q){if(!B){B=I("<div id='Popup' style='position:relative;zoom:1;overflow:auto'><label style='float:left;width:35px;padding:3px 5px 0 0;text-align:right'>url</label></div>");B.input=I("<input style='float:left;height:100%' />");B.ok=I("<span class='ui-tool ui-state-default'><a style='width:55px'>ok</a></span>");B.cancel=I("<span class='ui-tool ui-state-default'><a style='width:55px'>cancel</a></span>");B.append(B.input).append(B.ok).append(B.cancel).bind("click.htmlInput",function(W){W.stopPropagation()})}var O=S.toolbar.element.width(),U=S.toolbar.element.outerHeight();S.toolbar.element.append(B);B.input.width(O>500?335:O-175);B.width(O-2);if(P){if(R){B.cancel.contents("a").text("remove")}B.input.val(P[V])}else{B.input.val("")}S.toolbar.element.contents("span").animate({marginTop:-U},{duration:500,complete:function(){B.input.focus()}});B.buttons=B.ok.add(B.cancel);B.buttons.bind("mouseover.htmlInput",function(){I(this).addClass("ui-state-hover")}).bind("mouseout.htmlInput",function(){I(this).removeClass("ui-state-hover")}).bind("click.htmlInput",function(W){Q(I(this).contents("a").text()=="ok"?B.input.val():null);S.toolbar.element.contents("span").animate({marginTop:0},{duration:250,complete:function(){I(document).add(S.document).add(B.buttons).add(B.input).add(B).unbind(".htmlInput");B.remove()}});W.preventDefault()});I(document).add(S.document).bind("click.htmlInput",function(){B.cancel.click()});B.input.keydown(function(W){switch(W.which){case I.ui.keyCode.ENTER:B.ok.click();break;case I.ui.keyCode.ESCAPE:B.cancel.click();break}})}function F(R,Q,O,P){G(R,Q,O,"href",true,P)}function K(R,Q,P,O){G(R,Q,P,"src",false,O)}function J(P,O){this.element=I(P);this.tools={};this.element.bind("click.htmlInput",function(Q){Q.stopPropagation()}).addClass("ui-toolbar");this.add=function(Q,R){var S=I("<span class='ui-tool ".concat(Q,"'></span>"));this.element.append(S);if(R){S.append(R);R.attr("name",Q);S.command=R}S.selected=function(T){if(T){this.addClass("ui-state-active")}else{this.removeClass("ui-state-active")}};S.enabled=function(T){if(!T){this.addClass("ui-state-disabled")}else{this.removeClass("ui-state-disabled")}};this.tools[Q]=S;return S};this.addButton=function(Q){var R=I("<a title='".concat(Q.tooltip,"' tabindex='1000'>",Q.content,"</a>"));var S=this.add(Q.command,R).addClass("ui-state-default");R.bind("click.htmlInput",O);S.mouseover(function(){I(this).addClass("ui-state-hover")});S.mouseout(function(){I(this).removeClass("ui-state-hover")})};this.addList=function(Q){var T=I("<select title='".concat(Q.tooltip,"' tabindex='1000' style='height:100%'></select>"));var U=this.add(Q.command,T).addClass("ui-state-default");T.bind("change.htmlInput",O);for(var S in Q.content){var R="<option value='".concat(S,"'>",Q.content[S],"</option>");T.append(R)}};this.addSeparator=function(Q){this.add(Q.command,null)};this.addButtons=function(S){for(var R in S.tools){var Q=S.tools[R];if(Q.add){this["add"+Q.type](Q)}}}}function M(O,R,P,Q){this.type=O;this.command=R;this.content=P;this.add=true;this.tooltip=Q}var A={Button:"Button",List:"List",Separator:"Separator"};var H={bold:new M(A.Button,"bold","<strong>B</strong>","selection bold"),italic:new M(A.Button,"italic","<em>I</em>","selection itallic"),superscript:new M(A.Button,"superscript","X<sup>2</sup>","selection superscript"),subscript:new M(A.Button,"subscript","X<sub>2</sub>","selection subscript"),subSeparator:new M(A.Separator),removeFormat:new M(A.Button,"removeformat","~","remove selection formatting"),removeFormatSeparator:new M(A.Separator),block:new M(A.List,"formatBlock",{p:"Normal",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6",pre:"Preformatted"},"Format selection as..."),blockSeparator:new M(A.Separator),leftAlign:new M(A.Button,"left","&lArr;","left align"),middleAlign:new M(A.Button,"middle","&hArr;","middle align"),rightAlign:new M(A.Button,"right","&rArr;","right align"),rightAlignSeparator:new M(A.Separator),bulletList:new M(A.Button,"insertUnorderedList","&bull;&equiv;","selection as a numbered list"),numberList:new M(A.Button,"insertOrderedList","1&equiv;","selection as a bulleted list"),increaseIndent:new M(A.Button,"indent","&gt;&equiv;","increase indent"),decreaseIndent:new M(A.Button,"outdent","&lt;&equiv;","decrease indent"),decreaseIndentSeparator:new M(A.Separator),link:new M(A.Button,"link","<strong>&infin;</strong>","add/edit link"),image:new M(A.Button,"image","&#10065;","add/edit image")};I.extend(I.ui.htmlInput,{getter:"value",version:"1.1.0",eventPrefix:"htmlInput",defaults:{debug:false,styleUrl:"/content/editor.css",editLink:F,editImage:K,showToolbar:true,tools:H,widthAuto:false,baseUrl:false,allowedClasses:["left","middle","right"],canAlign:["img","p","h1","h2","h3","h4","h5","h6","th","td","li","dt"]}})})(jQuery);